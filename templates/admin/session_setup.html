{% extends "base.html" %}

{% block title %}Game Setup - Game Platform{% endblock %}

{% block head %}
{{ super() }}
<style>
    .category-selection {
        margin-bottom: 1.5rem;
    }
    
    .card-header-action {
        float: right;
    }
    
    .question-card {
        margin-bottom: 0.5rem;
        transition: all 0.2s;
        cursor: pointer;
    }
    
    .question-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .question-card.selected {
        border-color: #3498db;
        background-color: #f8f9fa;
    }
    
    .question-card.selected .card-header {
        background-color: #3498db;
        color: white;
    }
    
    .category-title {
        font-weight: bold;
    }
    
    .question-value {
        font-weight: bold;
        color: #e74c3c;
    }
    
    .selection-progress {
        margin-top: 0.5rem;
    }
    
    .position-badge {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        font-size: 0.8rem;
    }
    
    .setup-actions {
        position: sticky;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 1rem;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
    }
    
    .category-filter {
        margin-bottom: 1rem;
    }
    
    .session-name-container {
        margin-bottom: 2rem;
    }
    
    .collapse-toggle {
        cursor: pointer;
    }
    
    .position-indicator {
        width: 25px;
        height: 25px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        margin-right: 0.5rem;
        font-weight: bold;
        color: white;
        background-color: #6c757d;
    }
    
    .position-indicator.selected {
        background-color: #28a745;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h2 class="h4 mb-0">Game Session Setup</h2>
                </div>
                <div class="card-body">
                    <p class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Set up your game board by selecting 5 categories and 5 questions for each category.
                        You need to select exactly 5 questions per category (values $100-$500).
                    </p>
                    
                    <div class="session-name-container">
                        <label for="session-name" class="form-label">Session Name</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="session-name" placeholder="My Game Session">
                            <button class="btn btn-primary" id="save-session-btn">
                                <i class="fas fa-save me-2"></i>Save Session
                            </button>
                        </div>
                    </div>
                    
                    <!-- Category positions (1-5) -->
                    <div id="category-positions">
                        {% for position in range(1, 6) %}
                        <div class="category-selection" id="category-position-{{ position }}">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <div class="d-flex justify-content-between align-items-center collapse-toggle" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#category-content-{{ position }}" 
                                            aria-expanded="{{ 'true' if position == 1 else 'false' }}" 
                                            aria-controls="category-content-{{ position }}">
                                            
                                            <span>
                                                <span class="position-indicator">{{ position }}</span>
                                                Board Position {{ position }}: 
                                                <span class="selected-category-name" id="selected-category-name-{{ position }}">
                                                    Select a category
                                                </span>
                                            </span>
                                            
                                            <span class="text-muted">
                                                Questions: <span class="selected-questions-count" id="selected-questions-count-{{ position }}">0</span>/5
                                                <i class="fas fa-chevron-down ms-2"></i>
                                            </span>
                                        </div>
                                    </h5>
                                </div>
                                
                                <div id="category-content-{{ position }}" class="collapse {{ 'show' if position == 1 else '' }}">
                                    <div class="card-body">
                                        <div class="category-filter">
                                            <label for="category-select-{{ position }}" class="form-label">Select Category</label>
                                            <select class="form-select category-select" id="category-select-{{ position }}" data-position="{{ position }}">
                                                <option value="" selected>-- Choose a category --</option>
                                                <!-- Categories will be loaded here from the API -->
                                            </select>
                                        </div>
                                        
                                        <div class="question-selection" id="question-selection-{{ position }}">
                                            <!-- Questions will be loaded here when a category is selected -->
                                            <div class="alert alert-secondary">
                                                Please select a category to see available questions.
                                            </div>
                                        </div>
                                        
                                        <div class="selection-progress">
                                            <div class="progress">
                                                <div class="progress-bar" id="progress-{{ position }}" role="progressbar" style="width: 0%" 
                                                    aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="setup-actions text-center">
        <div class="alert alert-warning" id="setup-status">
            Please complete all category and question selections (5 categories with 5 questions each).
        </div>
        <div class="d-flex justify-content-between">
            <button class="btn btn-danger" id="cancel-setup-btn">
                <i class="fas fa-times me-2"></i>Cancel
            </button>
            <button class="btn btn-success" id="complete-setup-btn" disabled>
                <i class="fas fa-check me-2"></i>Complete Setup & Return to Admin
            </button>
        </div>
    </div>
</div>

<!-- Question Assignment Modal -->
<div class="modal fade" id="question-assignment-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Question Value</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Assign this question to a dollar value:</p>
                <input type="hidden" id="modal-question-id">
                <input type="hidden" id="modal-category-position">
                
                <div class="btn-group d-flex mb-3">
                    {% for value in [100, 200, 300, 400, 500] %}
                    <button class="btn btn-outline-primary question-value-btn" data-value="{{ value }}">
                        ${{ value }}
                    </button>
                    {% endfor %}
                </div>
                
                <div class="alert alert-info" id="value-assignment-info">
                    Click a value to assign the question.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // State management for the session setup
        const sessionState = {
            name: '',
            categories: {},
            isComplete: false,
            
            // Initialize with empty categories
            init: function() {
                for (let i = 1; i <= 5; i++) {
                    this.categories[i] = {
                        category_id: null,
                        category_name: '',
                        questions: {}
                    };
                }
            },
            
            // Set a category for a position
            setCategory: function(position, categoryId, categoryName) {
                this.categories[position].category_id = categoryId;
                this.categories[position].category_name = categoryName;
                this.categories[position].questions = {};
                this.updateUI();
            },
            
            // Add a question to a position and value
            setQuestion: function(position, questionId, questionValue, questionText) {
                const valuePosition = questionValue / 100;
                
                // Remove question if it was assigned to another value
                for (let val = 1; val <= 5; val++) {
                    if (this.categories[position].questions[val] && 
                        this.categories[position].questions[val].id === questionId) {
                        delete this.categories[position].questions[val];
                    }
                }
                
                this.categories[position].questions[valuePosition] = {
                    id: questionId,
                    value: questionValue,
                    text: questionText
                };
                
                this.updateUI();
            },
            
            // Remove a question
            removeQuestion: function(position, valuePosition) {
                if (this.categories[position].questions[valuePosition]) {
                    delete this.categories[position].questions[valuePosition];
                    this.updateUI();
                }
            },
            
            // Check if a question is assigned to a position and value
            isQuestionAssigned: function(position, valuePosition) {
                return !!this.categories[position].questions[valuePosition];
            },
            
            // Get the number of questions assigned to a category
            getQuestionCount: function(position) {
                return Object.keys(this.categories[position].questions).length;
            },
            
            // Check if a category position is complete (has 5 questions)
            isCategoryComplete: function(position) {
                return this.getQuestionCount(position) === 5;
            },
            
            // Check if all positions are complete
            isSetupComplete: function() {
                for (let i = 1; i <= 5; i++) {
                    if (!this.categories[i].category_id || !this.isCategoryComplete(i)) {
                        return false;
                    }
                }
                
                this.isComplete = true;
                return true;
            },
            
            // Update the UI based on the current state
            updateUI: function() {
                // Update each category position
                for (let position = 1; position <= 5; position++) {
                    const categoryData = this.categories[position];
                    const questionCount = this.getQuestionCount(position);
                    const progress = (questionCount / 5) * 100;
                    
                    // Update category name display
                    const categoryNameEl = document.getElementById(`selected-category-name-${position}`);
                    if (categoryNameEl) {
                        categoryNameEl.textContent = categoryData.category_name || 'Select a category';
                    }
                    
                    // Update question count display
                    const countEl = document.getElementById(`selected-questions-count-${position}`);
                    if (countEl) {
                        countEl.textContent = questionCount;
                    }
                    
                    // Update progress bar
                    const progressEl = document.getElementById(`progress-${position}`);
                    if (progressEl) {
                        progressEl.style.width = `${progress}%`;
                        progressEl.textContent = `${progress}%`;
                    }
                    
                    // Highlight selected questions in the UI
                    const questionCards = document.querySelectorAll(`#question-selection-${position} .question-card`);
                    questionCards.forEach(card => {
                        const questionId = card.getAttribute('data-question-id');
                        let isSelected = false;
                        
                        // Check if this question is selected for any value
                        for (let val = 1; val <= 5; val++) {
                            if (categoryData.questions[val] && categoryData.questions[val].id === questionId) {
                                isSelected = true;
                                
                                // Update the position badge
                                const badge = card.querySelector('.position-badge');
                                if (badge) {
                                    badge.textContent = `$${val * 100}`;
                                    badge.classList = 'position-badge badge bg-success';
                                }
                                break;
                            }
                        }
                        
                        // Toggle the selected class
                        card.classList.toggle('selected', isSelected);
                        
                        // If not selected, clear the badge
                        if (!isSelected) {
                            const badge = card.querySelector('.position-badge');
                            if (badge) {
                                badge.textContent = '';
                                badge.classList = 'position-badge';
                            }
                        }
                    });
                }
                
                // Check if setup is complete and update button state
                const isComplete = this.isSetupComplete();
                const completeBtn = document.getElementById('complete-setup-btn');
                if (completeBtn) {
                    completeBtn.disabled = !isComplete;
                }
                
                // Update status message
                const statusEl = document.getElementById('setup-status');
                if (statusEl) {
                    if (isComplete) {
                        statusEl.className = 'alert alert-success';
                        statusEl.innerHTML = '<i class="fas fa-check-circle me-2"></i>Setup complete! Click "Complete Setup" to continue.';
                    } else {
                        statusEl.className = 'alert alert-warning';
                        statusEl.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Please complete all category and question selections (5 categories with 5 questions each).';
                    }
                }
            },
            
            // Export the session data for saving
            exportData: function() {
                const data = {
                    name: document.getElementById('session-name').value || 'Game Session ' + new Date().toLocaleDateString(),
                    categories: []
                };
                
                for (let position = 1; position <= 5; position++) {
                    const categoryData = this.categories[position];
                    
                    if (categoryData.category_id) {
                        const category = {
                            category_id: categoryData.category_id,
                            position: position,
                            questions: []
                        };
                        
                        for (let valuePosition = 1; valuePosition <= 5; valuePosition++) {
                            if (categoryData.questions[valuePosition]) {
                                category.questions.push({
                                    question_id: categoryData.questions[valuePosition].id,
                                    position: valuePosition
                                });
                            }
                        }
                        
                        data.categories.push(category);
                    }
                }
                
                return data;
            }
        };
        
        // Initialize the session state
        sessionState.init();
        
        // Load categories from the API
        function loadCategories() {
            fetch('/api/admin/available-categories')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const categories = data.categories;
                        
                        // Populate category dropdowns
                        document.querySelectorAll('.category-select').forEach(select => {
                            // Clear existing options except the first one
                            while (select.options.length > 1) {
                                select.remove(1);
                            }
                            
                            // Add new options
                            categories.forEach(category => {
                                const option = document.createElement('option');
                                option.value = category.id;
                                option.textContent = category.name;
                                select.appendChild(option);
                            });
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading categories:', error);
                    alert('Failed to load categories. Please refresh the page and try again.');
                });
        }
        
        // Load questions for a category
        function loadQuestionsForCategory(categoryId, position) {
            fetch(`/api/admin/available-questions/${categoryId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const questions = data.questions;
                        const container = document.getElementById(`question-selection-${position}`);
                        
                        if (container) {
                            // Clear existing content
                            container.innerHTML = '';
                            
                            if (questions.length === 0) {
                                container.innerHTML = '<div class="alert alert-warning">No questions available for this category.</div>';
                                return;
                            }
                            
                            // Create cards for each question
                            questions.forEach(question => {
                                const card = document.createElement('div');
                                card.className = 'card question-card';
                                card.setAttribute('data-question-id', question.id);
                                card.innerHTML = `
                                    <div class="card-body">
                                        <span class="position-badge"></span>
                                        <p class="mb-0">${question.question_text}</p>
                                        <small class="text-muted">Answer: ${question.answer}</small>
                                    </div>
                                `;
                                
                                // Add click handler to assign a value
                                card.addEventListener('click', function() {
                                    // Only allow selection if the category has fewer than 5 questions selected
                                    if (sessionState.getQuestionCount(position) >= 5) {
                                        // Check if this question is already selected
                                        let isAlreadySelected = false;
                                        for (let val = 1; val <= 5; val++) {
                                            if (sessionState.categories[position].questions[val] && 
                                                sessionState.categories[position].questions[val].id === question.id) {
                                                isAlreadySelected = true;
                                                break;
                                            }
                                        }
                                        
                                        if (!isAlreadySelected) {
                                            alert('You can only select 5 questions per category. Please deselect a question before selecting a new one.');
                                            return;
                                        }
                                    }
                                    
                                    // Show the value assignment modal
                                    const modal = document.getElementById('question-assignment-modal');
                                    const modalInstance = new bootstrap.Modal(modal);
                                    
                                    // Set the question ID and position for the modal
                                    document.getElementById('modal-question-id').value = question.id;
                                    document.getElementById('modal-category-position').value = position;
                                    
                                    // Update the modal to show which values are already assigned
                                    document.querySelectorAll('.question-value-btn').forEach(btn => {
                                        const valuePosition = parseInt(btn.getAttribute('data-value')) / 100;
                                        const isAssigned = sessionState.isQuestionAssigned(position, valuePosition);
                                        
                                        if (isAssigned) {
                                            btn.classList.add('btn-secondary');
                                            btn.disabled = true;
                                        } else {
                                            btn.classList.remove('btn-secondary');
                                            btn.disabled = false;
                                        }
                                    });
                                    
                                    modalInstance.show();
                                });
                                
                                container.appendChild(card);
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading questions:', error);
                    alert('Failed to load questions. Please try again.');
                });
        }
        
        // Event listeners for category selection
        document.querySelectorAll('.category-select').forEach(select => {
            select.addEventListener('change', function() {
                const position = parseInt(this.getAttribute('data-position'));
                const categoryId = this.value;
                const categoryName = this.options[this.selectedIndex].text;
                
                if (categoryId) {
                    // Update the session state
                    sessionState.setCategory(position, categoryId, categoryName);
                    
                    // Load questions for this category
                    loadQuestionsForCategory(categoryId, position);
                } else {
                    // Clear questions if no category selected
                    const container = document.getElementById(`question-selection-${position}`);
                    if (container) {
                        container.innerHTML = '<div class="alert alert-secondary">Please select a category to see available questions.</div>';
                    }
                    
                    // Reset state for this position
                    sessionState.setCategory(position, null, '');
                }
            });
        });
        
        // Event listeners for question value assignment
        document.querySelectorAll('.question-value-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const value = parseInt(this.getAttribute('data-value'));
                const valuePosition = value / 100;
                const questionId = document.getElementById('modal-question-id').value;
                const position = parseInt(document.getElementById('modal-category-position').value);
                
                // Get the question text from the card
                const card = document.querySelector(`#question-selection-${position} .question-card[data-question-id="${questionId}"]`);
                const questionText = card ? card.querySelector('p').textContent : '';
                
                // Update the session state
                sessionState.setQuestion(position, questionId, value, questionText);
                
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('question-assignment-modal'));
                modal.hide();
            });
        });
        
        // Save session button click
        document.getElementById('save-session-btn').addEventListener('click', function() {
            const sessionName = document.getElementById('session-name').value;
            if (!sessionName) {
                alert('Please enter a name for this session.');
                return;
            }
            
            // Check if setup is at least partially complete
            let hasAnyData = false;
            for (let position = 1; position <= 5; position++) {
                if (sessionState.categories[position].category_id) {
                    hasAnyData = true;
                    break;
                }
            }
            
            if (!hasAnyData) {
                alert('Please select at least one category before saving.');
                return;
            }
            
            // Export and save the session data
            const sessionData = sessionState.exportData();
            
            fetch('/api/admin/save-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(sessionData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Session saved successfully!');
                } else {
                    alert('Failed to save session: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving session:', error);
                alert('Failed to save session. Please try again.');
            });
        });
        
        // Complete setup button click
        document.getElementById('complete-setup-btn').addEventListener('click', function() {
            if (!sessionState.isSetupComplete()) {
                alert('Please complete the setup by selecting 5 categories and 5 questions for each category.');
                return;
            }
            
            // Export and save the session data
            const sessionData = sessionState.exportData();
            
            fetch('/api/admin/save-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ...sessionData,
                    activate: true  // Indicate this should be the active session
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Setup completed successfully!');
                    // Redirect to the admin panel
                    window.location.href = '/admin';
                } else {
                    alert('Failed to complete setup: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving session:', error);
                alert('Failed to complete setup. Please try again.');
            });
        });
        
        // Cancel setup button click
        document.getElementById('cancel-setup-btn').addEventListener('click', function() {
            if (confirm('Are you sure you want to cancel this setup? All unsaved changes will be lost.')) {
                window.location.href = '/admin';
            }
        });
        
        // Load categories on page load
        loadCategories();
    });
</script>
{% endblock %}