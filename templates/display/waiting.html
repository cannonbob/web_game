<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Display</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Include Socket.IO library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <style>
        body {
            background-color: #2c3e50;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .game-title {
            font-size: 3rem;
            margin-bottom: 2rem;
            text-align: center;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .player-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            max-width: 1000px;
        }

        .player-card {
            background-color: #34495e;
            border-radius: 10px;
            padding: 1rem;
            width: 200px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }

        .player-card:hover {
            transform: translateY(-5px);
        }

        .player-name {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .player-score {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3498db;
        }

        .waiting-message {
            font-size: 2rem;
            margin-top: 2rem;
            text-align: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }
    </style>
</head>

<body>
    <div class="main-container">
        <h1 class="game-title">Game Platform</h1>

        <div class="player-list" id="player-list">
            {% for user in users %}
            {% if user.username != 'admin' %}
            <div class="player-card" data-username="{{ user.username }}">
                <div class="player-name">{{ user.username }}</div>
                <div class="player-score">{{ user.overall_score }}</div>
            </div>
            {% endif %}
            {% endfor %}
        </div>

        <div class="waiting-message">
            Waiting for admin to start a game...
        </div>
    </div>

    <!-- First load the Socket utility script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <!-- Load Socket utility after Socket.IO is loaded -->
    <script src="{{ url_for('static', filename='js/socket-utility.js') }}"></script>
    <script>
        // Initialize socket manager with debugging
        const socket = SocketManager.init();
        SocketManager.createStatusIndicator();
        SocketManager.debug.init();

        const logDebug = function (message) {
            SocketManager.debug.logMessage(message);
        };

        // Socket event handlers
        socket.on('user_joined', function (data) {
            logDebug('User joined: ' + data.username);
            updatePlayerList();
        });

        socket.on('user_left', function (data) {
            logDebug('User left: ' + data.username);
            updatePlayerList();
        });

        socket.on('platform_started', function () {
            logDebug('Platform started event received!');

            // Verify the game state has actually changed via direct API
            fetch('/api/platform_state_direct')
                .then(response => response.json())
                .then(state => {
                    logDebug(`Game state: active=${state.is_active}, game=${state.active_game}`);

                    if (state.is_active) {
                        logDebug('Game state is active, redirecting...');
                        // Force a full page reload to make sure we get the updated game state
                        window.location.href = '/display?t=' + new Date().getTime();
                    } else {
                        logDebug('WARNING: Game state is not active! Trying again in 1 second...');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                })
                .catch(error => {
                    logDebug('Error checking game state: ' + error);
                });
        });

        socket.on('game_started', function (data) {
            logDebug('Game started: ' + data.game);
            // Stay on /display - the route will automatically show the correct game
            window.location.href = '/display';
        });

        // Test event handler
        socket.on('test_response', function (data) {
            logDebug('Test response received: ' + JSON.stringify(data));
        });

        socket.on('display_refresh', function () {
            console.log('Display refresh event received');
            window.location.reload();
        });

        // Navigation handlers
        socket.on('admin_display_goto_game_board', function() {
            console.log('Admin navigation: goto game board');
            window.location.href = '/display';
        });

        socket.on('admin_display_goto_waiting_room', function() {
            console.log('Admin navigation: goto waiting room');
            window.location.href = '/display';
        });

        function updatePlayerList() {
            fetch('/api/users')
                .then(response => response.json())
                .then(users => {
                    const playerList = document.getElementById('player-list');
                    playerList.innerHTML = '';

                    // Filter out admin and sort players
                    const sortedUsers = users
                        .filter(user => user.username !== 'admin')
                        .sort((a, b) => {
                            // First sort by overall_score (descending)
                            if (b.overall_score !== a.overall_score) {
                                return b.overall_score - a.overall_score;
                            }
                            // If scores are tied, sort by username (ascending)
                            return a.username.localeCompare(b.username);
                        });

                    sortedUsers.forEach(user => {
                        const playerCard = document.createElement('div');
                        playerCard.className = 'player-card';
                        playerCard.setAttribute('data-username', user.username);

                        playerCard.innerHTML = `
                            <div class="player-name">${user.username}</div>
                            <div class="player-score">${user.overall_score}</div>
                        `;

                        playerList.appendChild(playerCard);
                    });

                    logDebug('Player list updated: ' + users.length + ' users');
                })
                .catch(error => {
                    logDebug('Error updating player list: ' + error);
                });
        }

        // Initial update
        updatePlayerList();
    </script>
</body>

</html>