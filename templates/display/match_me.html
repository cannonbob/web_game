<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Me - Game Display</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #2c3e50;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 2rem;
        }

        .game-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .question-text-fixed {
            font-size: 4rem;
            font-weight: bold;
            color: white;
            margin-bottom: 3rem;
            text-align: center;
            width: 100%;
        }

        .countdown {
            font-size: 8rem;
            color: #3498db;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .results-container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        .results-title {
            font-size: 3rem;
            margin-bottom: 2rem;
            color: #3498db;
        }


        .scores-table {
            width: 100%;
            background-color: #34495e;
            border-radius: 10px;
            overflow: hidden;
        }

        .scores-table th,
        .scores-table td {
            padding: 1rem;
            text-align: center;
        }

        .scores-table thead {
            background-color: #3498db;
        }

        .scores-table tr:nth-child(even) {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .first-place {
            color: gold;
            font-weight: bold;
        }

        .second-place {
            color: silver;
            font-weight: bold;
        }

        .third-place {
            color: #cd7f32;
            /* bronze */
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="game-header">
        <div class="question-text-fixed" id="question-text" style="display: none;"></div>
    </div>

    <div id="countdown-container" class="text-center mb-5"></div>

    <div id="results-container" class="results-container d-none">
        <h2 class="results-title">Ergebnisse</h2>

        <table class="scores-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Player</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody id="scores-table-body">
                <!-- Scores will be populated dynamically -->
            </tbody>
        </table>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <script>
        const socket = io();

        // Connect to the server
        socket.on('connect', function () {
            console.log('Display connected to server');
            // Request current game state in case we joined after initialization
            console.log('Requesting match_me game state');
            socket.emit('match_me_request_state', {});
        });

        // Handle game initialization
        socket.on('match_me_init', function (data) {
            console.log('Match Me Init received:', data);

            // Set question text
            if (data.question_text) {
                console.log('Setting question text:', data.question_text);
                document.getElementById('question-text').textContent = data.question_text;
            } else {
                console.log('No question text in data');
            }
        });

        // Handle countdown
        socket.on('match_me_countdown', function (data) {
            const countdownContainer = document.getElementById('countdown-container');
            countdownContainer.innerHTML = '';

            const countdownEl = document.createElement('div');
            countdownEl.className = 'countdown';
            countdownContainer.appendChild(countdownEl);

            let count = data.countdown;

            function updateCount() {
                countdownEl.textContent = count;

                if (count <= 0) {
                    clearInterval(interval);
                    countdownContainer.innerHTML = '';
                }

                count--;
            }

            updateCount();
            const interval = setInterval(updateCount, 1000);
        });

        // Handle player completion (no visual update needed - progress tracker removed)

        // Handle game over
        socket.on('match_me_game_over', function (data) {
            console.log('Match Me game over, showing results then redirecting');
            document.getElementById('results-container').classList.remove('d-none');


            const scores = data.scores;
            const sortedPlayers = Object.keys(scores).sort((a, b) => scores[b] - scores[a]);

            const scoresTableBody = document.getElementById('scores-table-body');
            scoresTableBody.innerHTML = '';

            sortedPlayers.forEach((player, index) => {
                const row = document.createElement('tr');

                // Add class for top 3 places
                if (index === 0) row.classList.add('first-place');
                else if (index === 1) row.classList.add('second-place');
                else if (index === 2) row.classList.add('third-place');

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${player}</td>
                    <td>${scores[player]}</td>
                `;

                scoresTableBody.appendChild(row);
            });

        });

        socket.on('display_refresh', function () {
            console.log('Display refresh event received');
            window.location.reload();
        });

        socket.on('admin_refresh_display', function() {
            console.log('Admin refresh display event received');
            window.location.reload();
        });

        // Admin navigation event listeners
        socket.on('admin_display_goto_game_board', function() {
            console.log('Admin navigation: goto game board');
            window.location.href = '/display';
        });

        socket.on('admin_display_goto_waiting_room', function() {
            console.log('Admin navigation: goto waiting room');
            window.location.href = '/display';
        });

        // Handle reveal_question event from admin
        socket.on('reveal_question', function() {
            console.log('Reveal question event received');
            const questionTextElement = document.getElementById('question-text');
            console.log('Question text element:', questionTextElement);
            console.log('Question text content:', questionTextElement ? questionTextElement.textContent : 'element not found');

            if (questionTextElement) {
                if (questionTextElement.textContent && questionTextElement.textContent.trim() !== '') {
                    console.log('Showing question text');
                    questionTextElement.style.display = 'block';
                } else {
                    console.log('Question text is empty, cannot show');
                }
            } else {
                console.log('Question text element not found');
            }
        });
    </script>
</body>

</html>