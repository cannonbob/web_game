<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hidden Object Game</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 1200px;
            width: 100%;
        }

        .game-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .game-title {
            font-size: 2.5em;
            color: #333;
            margin: 0;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .game-stats {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            font-size: 1.2em;
            font-weight: bold;
        }

        .stat-item {
            padding: 10px 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .images-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .image-section {
            text-align: center;
            position: relative;
        }

        .image-title {
            font-size: 1.3em;
            margin-bottom: 10px;
            color: #333;
            font-weight: bold;
        }

        canvas {
            border: 3px solid #ddd;
            border-radius: 10px;
            cursor: crosshair;
            max-width: 100%;
            height: auto;
            transition: transform 0.2s ease;
        }

        canvas:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .controls {
            margin: 20px 0;
            text-align: center;
        }

        .upload-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #667eea;
            border-radius: 10px;
            background: rgba(102, 126, 234, 0.05);
        }

        .file-input {
            margin: 10px;
            padding: 10px 20px;
            border: none;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
        }

        .file-input:hover {
            background: linear-gradient(45deg, #764ba2, #667eea);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button {
            padding: 12px 25px;
            margin: 5px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transition: all 0.3s ease;
        }

        button:hover {
            background: linear-gradient(45deg, #764ba2, #667eea);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .difference-marker {
            position: absolute;
            border: 3px solid #ff4757;
            border-radius: 50%;
            background: rgba(255, 71, 87, 0.2);
            pointer-events: none;
            animation: pulse 1s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }

        .victory-message {
            text-align: center;
            padding: 30px;
            background: linear-gradient(45deg, #26de81, #20bf6b);
            color: white;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 1.5em;
            font-weight: bold;
            animation: bounce 0.6s ease-in-out;
        }

        @keyframes bounce {
            0%, 20%, 60%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            80% { transform: translateY(-10px); }
        }

        .detection-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 10px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: bold;
            color: #333;
        }

        .control-group input[type="range"] {
            width: 100%;
        }

        .debug-info {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9em;
            display: none;
        }

        .method-selector {
            margin: 10px 0;
        }

        .method-selector label {
            margin-right: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1 class="game-title">Hidden Object Game</h1>
            <p>Advanced difference detection for small and large changes!</p>
        </div>

        <div class="upload-section">
            <div>
                <label for="original-upload" class="file-input">Choose Original Image</label>
                <input type="file" id="original-upload" accept="image/*" style="display: none;">
            </div>
            <div>
                <label for="modified-upload" class="file-input">Choose Modified Image</label>
                <input type="file" id="modified-upload" accept="image/*" style="display: none;">
            </div>
            
            <div class="method-selector">
                <label>Detection Method:</label>
                <label><input type="radio" name="method" value="hybrid" checked> Hybrid (Best)</label>
                <label><input type="radio" name="method" value="grid"> Grid Scan</label>
                <label><input type="radio" name="method" value="edge"> Edge Detection</label>
            </div>

            <div class="detection-controls">
                <div class="control-group">
                    <label>Sensitivity: <span id="sensitivity-value">40</span></label>
                    <input type="range" id="sensitivity" min="10" max="100" value="40">
                </div>
                <div class="control-group">
                    <label>Min Difference Size: <span id="min-size-value">5</span></label>
                    <input type="range" id="min-size" min="1" max="50" value="5">
                </div>
                <div class="control-group">
                    <label>Cluster Distance: <span id="cluster-value">30</span></label>
                    <input type="range" id="cluster-distance" min="10" max="100" value="30">
                </div>
                <div class="control-group">
                    <label>Scan Grid Size: <span id="grid-value">20</span></label>
                    <input type="range" id="grid-size" min="10" max="50" value="20">
                </div>
            </div>

            <div>
                <button onclick="analyzeImages()">Analyze Differences</button>
                <button onclick="newGame()">New Game</button>
                <button onclick="toggleDebug()">Toggle Debug</button>
            </div>

            <div id="debug-info" class="debug-info"></div>
        </div>

        <div class="game-stats">
            <div class="stat-item">Found: <span id="found-count">0</span></div>
            <div class="stat-item">Total: <span id="total-count">0</span></div>
            <div class="stat-item">Time: <span id="timer">0:00</span></div>
        </div>

        <div class="images-container">
            <div class="image-section">
                <div class="image-title">Original Image</div>
                <canvas id="original-canvas"></canvas>
            </div>
            <div class="image-section">
                <div class="image-title">Find the Differences!</div>
                <canvas id="game-canvas" onclick="handleClick(event)"></canvas>
            </div>
        </div>

        <div id="victory-message" style="display: none;" class="victory-message">
            ðŸŽ‰ Congratulations! You found all differences! ðŸŽ‰
        </div>
    </div>

    <script>
        let originalImage = null;
        let modifiedImage = null;
        let differences = [];
        let foundDifferences = new Set();
        let gameStartTime = null;
        let timerInterval = null;
        let debugMode = false;

        // File upload handlers
        document.getElementById('original-upload').addEventListener('change', function(e) {
            loadImage(e.target.files[0], 'original');
        });

        document.getElementById('modified-upload').addEventListener('change', function(e) {
            loadImage(e.target.files[0], 'modified');
        });

        // Control sliders
        ['sensitivity', 'min-size', 'cluster-distance', 'grid-size'].forEach(id => {
            document.getElementById(id).addEventListener('input', function(e) {
                document.getElementById(id + '-value').textContent = e.target.value;
            });
        });

        function loadImage(file, type) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    if (type === 'original') {
                        originalImage = img;
                        drawImage(img, 'original-canvas');
                    } else {
                        modifiedImage = img;
                        drawImage(img, 'game-canvas');
                    }
                    
                    if (originalImage && modifiedImage) {
                        document.querySelector('button[onclick="analyzeImages()"]').style.display = 'inline-block';
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function drawImage(img, canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
        }

        function analyzeImages() {
            if (!originalImage || !modifiedImage) {
                alert('Please upload both images first!');
                return;
            }

            const method = document.querySelector('input[name="method"]:checked').value;
            const sensitivity = parseInt(document.getElementById('sensitivity').value);
            const minSize = parseInt(document.getElementById('min-size').value);
            const clusterDistance = parseInt(document.getElementById('cluster-distance').value);
            const gridSize = parseInt(document.getElementById('grid-size').value);

            let differencePoints = [];

            switch(method) {
                case 'hybrid':
                    differencePoints = hybridDetection(sensitivity, minSize, gridSize);
                    break;
                case 'grid':
                    differencePoints = gridScanDetection(sensitivity, gridSize);
                    break;
                case 'edge':
                    differencePoints = edgeDetection(sensitivity);
                    break;
            }

            differences = clusterDifferences(differencePoints, clusterDistance);
            
            updateDebugInfo(differencePoints, differences);
            
            document.getElementById('total-count').textContent = differences.length;
            document.getElementById('found-count').textContent = '0';
            foundDifferences.clear();
            
            if (differences.length === 0) {
                alert('No differences found! Try adjusting the sensitivity or method.');
                return;
            }

            startGame();
        }

        function hybridDetection(sensitivity, minSize, gridSize) {
            // Combine multiple detection methods for better results
            const gridPoints = gridScanDetection(sensitivity, gridSize);
            const edgePoints = edgeDetection(sensitivity * 0.7); // Lower threshold for edges
            
            // Merge and deduplicate
            const allPoints = [...gridPoints, ...edgePoints];
            return removeDuplicatePoints(allPoints, 10);
        }

        function gridScanDetection(sensitivity, gridSize) {
            const canvas1 = document.createElement('canvas');
            const canvas2 = document.createElement('canvas');
            const ctx1 = canvas1.getContext('2d');
            const ctx2 = canvas2.getContext('2d');

            canvas1.width = canvas2.width = originalImage.width;
            canvas1.height = canvas2.height = originalImage.height;

            ctx1.drawImage(originalImage, 0, 0);
            ctx2.drawImage(modifiedImage, 0, 0);

            const data1 = ctx1.getImageData(0, 0, originalImage.width, originalImage.height);
            const data2 = ctx2.getImageData(0, 0, modifiedImage.width, modifiedImage.height);

            const points = [];

            // Scan in overlapping grid pattern
            for (let y = 0; y < originalImage.height - gridSize; y += gridSize / 2) {
                for (let x = 0; x < originalImage.width - gridSize; x += gridSize / 2) {
                    const regionDiff = calculateRegionDifference(data1, data2, x, y, gridSize, originalImage.width);
                    
                    if (regionDiff > sensitivity) {
                        // Find the most different pixel in this region
                        const centerPoint = findRegionCenter(data1, data2, x, y, gridSize, originalImage.width);
                        points.push({
                            x: centerPoint.x,
                            y: centerPoint.y,
                            intensity: regionDiff
                        });
                    }
                }
            }

            return points;
        }

        function edgeDetection(sensitivity) {
            // Detect differences using edge detection approach
            const canvas1 = document.createElement('canvas');
            const canvas2 = document.createElement('canvas');
            const ctx1 = canvas1.getContext('2d');
            const ctx2 = canvas2.getContext('2d');

            canvas1.width = canvas2.width = originalImage.width;
            canvas1.height = canvas2.height = originalImage.height;

            ctx1.drawImage(originalImage, 0, 0);
            ctx2.drawImage(modifiedImage, 0, 0);

            const data1 = ctx1.getImageData(0, 0, originalImage.width, originalImage.height);
            const data2 = ctx2.getImageData(0, 0, modifiedImage.width, modifiedImage.height);

            const points = [];

            // Sobel edge detection on difference image
            for (let y = 1; y < originalImage.height - 1; y++) {
                for (let x = 1; x < originalImage.width - 1; x++) {
                    const edgeStrength = calculateSobelDifference(data1, data2, x, y, originalImage.width);
                    
                    if (edgeStrength > sensitivity) {
                        points.push({
                            x: x,
                            y: y,
                            intensity: edgeStrength
                        });
                    }
                }
            }

            return points;
        }

        function calculateRegionDifference(data1, data2, startX, startY, size, width) {
            let totalDiff = 0;
            let pixelCount = 0;

            for (let y = startY; y < Math.min(startY + size, data1.height); y++) {
                for (let x = startX; x < Math.min(startX + size, width); x++) {
                    const i = (y * width + x) * 4;
                    const diff = Math.abs(data1.data[i] - data2.data[i]) +
                               Math.abs(data1.data[i + 1] - data2.data[i + 1]) +
                               Math.abs(data1.data[i + 2] - data2.data[i + 2]);
                    totalDiff += diff;
                    pixelCount++;
                }
            }

            return pixelCount > 0 ? totalDiff / pixelCount : 0;
        }

        function findRegionCenter(data1, data2, startX, startY, size, width) {
            let maxDiff = 0;
            let centerX = startX + size / 2;
            let centerY = startY + size / 2;

            for (let y = startY; y < Math.min(startY + size, data1.height); y++) {
                for (let x = startX; x < Math.min(startX + size, width); x++) {
                    const i = (y * width + x) * 4;
                    const diff = Math.abs(data1.data[i] - data2.data[i]) +
                               Math.abs(data1.data[i + 1] - data2.data[i + 1]) +
                               Math.abs(data1.data[i + 2] - data2.data[i + 2]);
                    
                    if (diff > maxDiff) {
                        maxDiff = diff;
                        centerX = x;
                        centerY = y;
                    }
                }
            }

            return { x: centerX, y: centerY };
        }

        function calculateSobelDifference(data1, data2, x, y, width) {
            const sobelX = [-1, 0, 1, -2, 0, 2, -1, 0, 1];
            const sobelY = [-1, -2, -1, 0, 0, 0, 1, 2, 1];
            
            let gx = 0, gy = 0;
            
            for (let j = -1; j <= 1; j++) {
                for (let i = -1; i <= 1; i++) {
                    const idx = ((y + j) * width + (x + i)) * 4;
                    const diff1 = Math.abs(data1.data[idx] - data2.data[idx]) +
                                 Math.abs(data1.data[idx + 1] - data2.data[idx + 1]) +
                                 Math.abs(data1.data[idx + 2] - data2.data[idx + 2]);
                    
                    const kernelIdx = (j + 1) * 3 + (i + 1);
                    gx += diff1 * sobelX[kernelIdx];
                    gy += diff1 * sobelY[kernelIdx];
                }
            }
            
            return Math.sqrt(gx * gx + gy * gy);
        }

        function removeDuplicatePoints(points, threshold) {
            const filtered = [];
            
            for (const point of points) {
                let isDuplicate = false;
                for (const existing of filtered) {
                    const distance = Math.sqrt(
                        Math.pow(point.x - existing.x, 2) + 
                        Math.pow(point.y - existing.y, 2)
                    );
                    if (distance < threshold) {
                        isDuplicate = true;
                        // Keep the point with higher intensity
                        if (point.intensity > existing.intensity) {
                            existing.x = point.x;
                            existing.y = point.y;
                            existing.intensity = point.intensity;
                        }
                        break;
                    }
                }
                if (!isDuplicate) {
                    filtered.push(point);
                }
            }
            
            return filtered;
        }

        function clusterDifferences(points, clusterDistance) {
            if (points.length === 0) return [];

            const clusters = [];
            const used = new Set();

            for (let i = 0; i < points.length; i++) {
                if (used.has(i)) continue;

                const cluster = [points[i]];
                used.add(i);

                // Find nearby points
                for (let j = i + 1; j < points.length; j++) {
                    if (used.has(j)) continue;

                    const distance = Math.sqrt(
                        Math.pow(points[i].x - points[j].x, 2) + 
                        Math.pow(points[i].y - points[j].y, 2)
                    );

                    if (distance <= clusterDistance) {
                        cluster.push(points[j]);
                        used.add(j);
                    }
                }

                // Calculate cluster center and radius
                const centerX = cluster.reduce((sum, p) => sum + p.x, 0) / cluster.length;
                const centerY = cluster.reduce((sum, p) => sum + p.y, 0) / cluster.length;
                const maxDistance = Math.max(...cluster.map(p => 
                    Math.sqrt(Math.pow(p.x - centerX, 2) + Math.pow(p.y - centerY, 2))
                ));

                clusters.push({
                    centerX: centerX,
                    centerY: centerY,
                    radius: Math.max(15, maxDistance + 10), // Minimum click radius
                    pointCount: cluster.length,
                    avgIntensity: cluster.reduce((sum, p) => sum + p.intensity, 0) / cluster.length
                });
            }

            // Sort by intensity (stronger differences first)
            return clusters.sort((a, b) => b.avgIntensity - a.avgIntensity);
        }

        function updateDebugInfo(points, clusters) {
            if (!debugMode) return;
            
            const debugDiv = document.getElementById('debug-info');
            debugDiv.innerHTML = `
                <strong>Detection Results:</strong><br>
                Raw difference points: ${points.length}<br>
                Clustered regions: ${clusters.length}<br>
                <strong>Clusters:</strong><br>
                ${clusters.map((c, i) => 
                    `${i+1}: (${Math.round(c.centerX)}, ${Math.round(c.centerY)}) 
                     radius: ${Math.round(c.radius)} 
                     points: ${c.pointCount} 
                     intensity: ${Math.round(c.avgIntensity)}`
                ).join('<br>')}
            `;
        }

        function toggleDebug() {
            debugMode = !debugMode;
            document.getElementById('debug-info').style.display = debugMode ? 'block' : 'none';
        }

        function startGame() {
            gameStartTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
            document.getElementById('victory-message').style.display = 'none';
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - gameStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function handleClick(event) {
            if (!gameStartTime) return;

            const canvas = document.getElementById('game-canvas');
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const clickX = (event.clientX - rect.left) * scaleX;
            const clickY = (event.clientY - rect.top) * scaleY;

            for (let i = 0; i < differences.length; i++) {
                if (foundDifferences.has(i)) continue;

                const diff = differences[i];
                const distance = Math.sqrt(
                    Math.pow(clickX - diff.centerX, 2) + 
                    Math.pow(clickY - diff.centerY, 2)
                );

                if (distance <= diff.radius) {
                    foundDifferences.add(i);
                    markDifference(diff.centerX, diff.centerY, diff.radius);
                    
                    document.getElementById('found-count').textContent = foundDifferences.size;
                    
                    if (foundDifferences.size === differences.length) {
                        endGame();
                    }
                    return;
                }
            }
        }

        function markDifference(x, y, radius) {
            const canvas = document.getElementById('game-canvas');
            const ctx = canvas.getContext('2d');
            
            ctx.strokeStyle = '#ff4757';
            ctx.fillStyle = 'rgba(255, 71, 87, 0.2)';
            ctx.lineWidth = 3;
            
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, 2 * Math.PI);
            ctx.fill();
            ctx.stroke();
        }

        function endGame() {
            clearInterval(timerInterval);
            document.getElementById('victory-message').style.display = 'block';
        }

        function newGame() {
            clearInterval(timerInterval);
            foundDifferences.clear();
            differences = [];
            gameStartTime = null;
            
            document.getElementById('found-count').textContent = '0';
            document.getElementById('total-count').textContent = '0';
            document.getElementById('timer').textContent = '0:00';
            document.getElementById('victory-message').style.display = 'none';
            
            if (modifiedImage) {
                drawImage(modifiedImage, 'game-canvas');
            }
        }
    </script>
</body>
</html>